# See .env to set useful environment vars

services:
  http-cache:
    image: varnish:6.0
    container_name: "${APP_NAME}-http-cache"
    # allow linux hosts to resolve host.docker.internal
    extra_hosts:
      - "host.docker.internal=host-gateway"
    ports:
      - "8084:6081"   # client â†’ Varnish
      - "8085:6082"   # varnish admin
    volumes:
        - ./varnish/default.vcl:/etc/varnish/default.vcl
    command: [ "varnishd", "-F", "-f", "/etc/varnish/default.vcl", "-s", "malloc,256m", "-a", ":6081" ]

  app:
    # allow linux hosts to resolve host.docker.internal
    extra_hosts:
      - "host.docker.internal=host-gateway"
    build:
      context: ./
      dockerfile: frankenphp/Dockerfile
      target: frankenphp_dev
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
        DOCKER_GID: ${DOCKER_GID:-1001}
        APP_USER: ${APP_USER:-symfony}
    container_name: "${APP_NAME}-web"
    restart: unless-stopped
    # FIXME : using a non root user works on windows only after already started the container as root at least once
    # user: ${APP_USER:-symfony}
    user: root
    volumes:
      # Mounting files / directories separately for performance on windows hosts
      # Avoid mounting the var directory as it is unreliable
      # Mounting the project root on windows Hosts may compromise perfs, it is recommended to mount dir/files individually
      #      - ../../backend/back:/app:delegated
      - ../../backend/src:/app/src
      - ../../backend/assets:/app/assets
      - ../../backend/bin:/app/bin
      - ../../backend/tests:/app/tests
      - ../../backend/config:/app/config
      - ../../backend/templates:/app/templates
      - ../../backend/public:/app/public
      - ../../backend/composer.json:/app/composer.json
      - ../../backend/composer.lock:/app/composer.lock
      - ../../backend/.env:/app/.env
      - ../../backend/.env.dev:/app/.env.dev
      - ../../backend/importmap.php:/app/importmap.php


      # bad performance when mounting vendor on Windows machines
      - ../../backend/vendor:/app/vendor:delegated
      # Windows (WSL) / Linux
      # Mounting docker socket is necessary to enable TestContainers to create containers
      # On windows hosts, you may be able to comment this line, expose the docker API via TCP in Docker Desktop
      # and then set DOCKER_HOST env variable, although it's not recommended
      - /var/run/docker.sock:/var/run/docker.sock:rw
    env_file:
      - .env
    environment:
      XDEBUG_MODE: debug
      XDEBUG_START_WITH_REQUEST: yes
      XDEBUG_CONFIG=client_host: host.docker.internal
    # comment the following line in production, it allows to have nice human-readable logs in dev
    tty: true


      # macOS (UNTESTED): it seems that to allow Testcontainers to create containers, the docker API should be exposed through TCP
      # in Docker Desktop
      # Then the DOCKER_HOST var below should be set (change port if necessary)
      # DOCKER_HOST: tcp://host.docker.internal:2375

    ports:
      - "8083:80"   # FrankenPHP
    networks:
      - app

volumes:
  postgresql_data:

networks:
  app:
    driver: bridge